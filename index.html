<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>–ò–Ω–≤–µ—Å—Ç–∫–æ–º–∏—Ç–µ—Ç Wisdom (Secure)</title>
  <style>
    :root{
      --bg:#0f1116;
      --panel:#151925;
      --panel2:#0c0f18;
      --border:#252b3a;
      --text:#e7eaf0;
      --muted:#9aa3b2;
      --accent:#7c5cff;
      --good:#4CAF50;
      --warn:#ffb020;
      --bad:#F44336;
      --info:#2aa9ff;
      --mono: ui-monospace, Menlo, Consolas, "SFMono-Regular", monospace;
      --radius:12px;
    }
    *{ box-sizing:border-box; }
    body{
      font-family: system-ui, -apple-system, "Segoe UI", Roboto, Arial, sans-serif;
      background:var(--bg);
      color:var(--text);
      margin:0;
      padding:18px;
    }
    .wrap{ max-width: 1320px; margin:0 auto; }
    h1{ margin:0 0 10px; font-size: 22px; }
    h2{ margin:0 0 10px; font-size: 16px; color: var(--text); }
    h3{ margin:0 0 10px; font-size: 14px; color: var(--text); }
    p{ margin:8px 0; }
    a{ color:#9bd1ff; text-decoration:none; }
    a:hover{ text-decoration:underline; }

    .card{
      background:var(--panel);
      border:1px solid var(--border);
      border-radius:var(--radius);
      padding:14px;
      margin-bottom:12px;
    }

    .muted{ color:var(--muted); font-size:12px; }
    label{ display:block; font-size:12px; color:var(--muted); margin:8px 0 6px; }
    input, textarea, select{
      width:100%;
      background:var(--panel2);
      border:1px solid var(--border);
      color:var(--text);
      padding:10px;
      border-radius:10px;
      outline:none;
    }
    textarea{ resize:vertical; }
    button{
      padding:10px 12px;
      border-radius:10px;
      border:1px solid var(--border);
      background:var(--accent);
      color:#fff;
      font-weight:700;
      cursor:pointer;
    }
    button.secondary{
      background:var(--panel2);
    }
    button:disabled{
      opacity:.5;
      cursor:not-allowed;
    }

    .row{ display:grid; grid-template-columns: 1fr 1fr; gap:10px; }
    .row3{ display:grid; grid-template-columns: 1fr 1fr 1fr; gap:10px; }
    .row4{ display:grid; grid-template-columns: 1fr 1fr 1fr 1fr; gap:10px; }
    @media (max-width: 1050px){
      .row4{ grid-template-columns: 1fr 1fr; }
    }
    @media (max-width: 740px){
      .row, .row3, .row4{ grid-template-columns: 1fr; }
      body{ padding:12px; }
    }

    .toolbar{ display:flex; gap:10px; flex-wrap:wrap; align-items:center; }
    .toolbar button{ margin-top:0; }

    pre{
      white-space:pre-wrap;
      background:var(--panel2);
      border:1px solid var(--border);
      padding:10px;
      border-radius:10px;
      font-family: var(--mono);
      font-size: 12px;
      line-height: 1.45;
      overflow:auto;
    }

    .badge{
      display:inline-flex;
      align-items:center;
      gap:8px;
      padding:6px 10px;
      border-radius:999px;
      border:1px solid var(--border);
      background:rgba(255,255,255,0.03);
      font-size:12px;
      color:var(--muted);
    }
    .dot{ width:9px; height:9px; border-radius:50%; background:var(--muted); display:inline-block; }
    .dot.good{ background: var(--good); }
    .dot.warn{ background: var(--warn); }
    .dot.bad{ background: var(--bad); }
    .dot.info{ background: var(--info); }

    .gridRoles{
      display:grid;
      grid-template-columns: repeat(4, 1fr);
      gap:12px;
    }
    @media (max-width: 1100px){
      .gridRoles{ grid-template-columns: repeat(2, 1fr); }
    }
    @media (max-width: 740px){
      .gridRoles{ grid-template-columns: 1fr; }
    }
    .roleCard{
      background:var(--panel);
      border:1px solid var(--border);
      border-radius:var(--radius);
      padding:12px;
      min-height: 140px;
      border-top: 4px solid #555;
    }
    .roleCard.optimist{ border-top-color: var(--good); }
    .roleCard.pessimist{ border-top-color: var(--bad); }
    .roleCard.realist{ border-top-color: var(--info); }
    .roleCard.quant{ border-top-color: #b56cff; }
    .roleCard h3{
      margin:0 0 8px;
      font-size: 12px;
      letter-spacing:.04em;
      text-transform:uppercase;
      color: var(--muted);
    }
    .roleText{
      white-space:pre-wrap;
      font-size: 13px;
      line-height: 1.55;
      color: var(--text);
      min-height: 110px;
    }
    .loading{
      color: var(--muted);
      font-style: italic;
      animation: pulse 1.5s infinite;
    }
    @keyframes pulse{ 0%{opacity:.5} 50%{opacity:1} 100%{opacity:.5} }

    table{
      width:100%;
      border-collapse:separate;
      border-spacing:0;
      overflow:hidden;
      border-radius: 12px;
      border:1px solid var(--border);
      background:var(--panel2);
    }
    th, td{
      padding:10px;
      border-bottom:1px solid var(--border);
      vertical-align:top;
      text-align:left;
      font-size: 12px;
      line-height: 1.45;
    }
    th{ color: var(--muted); background: rgba(255,255,255,0.03); }
    tr:last-child td{ border-bottom:none; }

    .tabs{ display:flex; gap:8px; flex-wrap:wrap; margin-bottom:10px; }
    .tab{
      padding:8px 10px;
      border-radius:10px;
      border:1px solid var(--border);
      background:var(--panel2);
      cursor:pointer;
      font-size:12px;
      color:var(--muted);
      user-select:none;
    }
    .tab.active{
      background:rgba(124,92,255,0.18);
      color:var(--text);
      border-color: rgba(124,92,255,0.45);
    }
    .hidden{ display:none; }

    .note{
      border-left: 3px solid rgba(124,92,255,0.7);
      padding-left: 12px;
      margin: 10px 0;
      color: var(--muted);
      font-size: 12px;
    }

    .checkboxRow{ display:flex; gap:10px; align-items:center; }
    .checkboxRow input{ width:auto; }
    .smallBtn{
      padding:7px 10px;
      font-weight:600;
      font-size:12px;
    }
  </style>
</head>
<body>
<div class="wrap">
  <h1>üèõ –ò–Ω–≤–µ—Å—Ç–∫–æ–º–∏—Ç–µ—Ç Wisdom (Secure)</h1>
  <div class="muted">UI –±–µ–∑ –∫–ª—é—á–µ–π. –í—Å—ë –∏—Å–ø–æ–ª–Ω—è–µ—Ç—Å—è –Ω–∞ –≤–∞—à–µ–º backend. Flow: Estimate ‚Üí Run ‚Üí Review ‚Üí Approve ‚Üí PDF (+ –∏—Å—Ç–æ—Ä–∏—è –ø—Ä–æ–≥–æ–Ω–æ–≤).</div>

  <!-- INPUTS -->
  <div class="card">
    <h2>1) –ó–∞–ø—Ä–æ—Å –∏ –≤–≤–æ–¥–Ω—ã–µ (inputs)</h2>

    <div class="row">
      <div>
        <label>–¢–∏–∫–µ—Ä(–∞) / Symbols (—á–µ—Ä–µ–∑ –∑–∞–ø—è—Ç—É—é)</label>
        <input id="symbols" value="AAPL" placeholder="–ù–∞–ø—Ä–∏–º–µ—Ä: AAPL –∏–ª–∏ AAPL,MSFT" />
      </div>
      <div>
        <label>–†–µ–∂–∏–º (mode)</label>
        <select id="mode">
          <option value="ticker" selected>Ticker</option>
          <option value="options">Options</option>
          <option value="macro">Macro</option>
          <option value="custom">Custom</option>
        </select>
      </div>
    </div>

    <label>–í–æ–ø—Ä–æ—Å / prompt</label>
    <textarea id="prompt" rows="3" placeholder="–ù–∞–ø—Ä–∏–º–µ—Ä: –°–¥–µ–ª–∞–π FULL –ø—Ä–æ—Ç–æ–∫–æ–ª –ò–Ω–≤–µ—Å—Ç–∫–æ–º–∏—Ç–µ—Ç–∞ –ø–æ AAPL. –ì–æ—Ä–∏–∑–æ–Ω—Ç 12 –º–µ—Å—è—Ü–µ–≤, USD. –ë–µ–Ω—á–º–∞—Ä–∫: XLK –∏ SPY."></textarea>

    <div class="row4" style="margin-top:10px;">
      <div>
        <label>Output Mode (requested)</label>
        <select id="outmode">
          <option value="AUTO" selected>AUTO</option>
          <option value="FULL_PROTOCOL">FULL_PROTOCOL</option>
          <option value="ONE_PAGER">ONE_PAGER</option>
        </select>
        <div class="muted">AUTO –º–æ–∂–µ—Ç –ø–µ—Ä–µ–∫–ª—é—á–∏—Ç—å –≤ ONE_PAGER –ø—Ä–∏ –ø—Ä–µ–≤—ã—à–µ–Ω–∏–∏ –±—é–¥–∂–µ—Ç–∞.</div>
      </div>
      <div>
        <label>Quant Mode</label>
        <select id="qmode">
          <option value="AUTO" selected>AUTO</option>
          <option value="ON">ON</option>
          <option value="OFF">OFF</option>
        </select>
        <div class="muted">AUTO –≤–∫–ª—é—á–∞–µ—Ç Quant –ø—Ä–∏ –¥–µ—Ä–∏–≤–∞—Ç–∏–≤–∞—Ö –∏–ª–∏ –∑–∞–ø—Ä–æ—Å–µ —Ü–∏—Ñ—Ä/–≥—Ä–∞—Ñ–∏–∫–æ–≤.</div>
      </div>
      <div>
        <label>–°—Ç—Ä–æ–≥–æ—Å—Ç—å –∫—Ä–∏—Ç–∏–∫–∏ (harshness)</label>
        <select id="harshness">
          <option value="medium">medium</option>
          <option value="hard" selected>hard</option>
          <option value="nuclear">nuclear</option>
        </select>
      </div>
      <div>
        <label>–ú–∞–∫—Å. —Ä–∞—É–Ω–¥–æ–≤</label>
        <select id="maxRounds">
          <option value="1">1</option>
          <option value="2">2</option>
          <option value="3" selected>3</option>
        </select>
      </div>
    </div>

    <div class="row" style="margin-top:10px;">
      <div>
        <label>–ì–æ—Ä–∏–∑–æ–Ω—Ç (horizon_days)</label>
        <div class="row">
          <select id="horizonPreset" onchange="applyHorizonPreset()">
            <option value="custom" selected>–°–≤–æ—è –¥–ª–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å</option>
            <option value="90">~3 –º–µ—Å—è—Ü–∞ (90d)</option>
            <option value="270">~6‚Äì12 –º–µ—Å—è—Ü–µ–≤ (270d)</option>
            <option value="730">~1‚Äì3 –≥–æ–¥–∞ (730d)</option>
            <option value="1460">~3‚Äì5 –ª–µ—Ç (1460d)</option>
          </select>
          <input id="horizonDays" type="number" min="1" value="365" />
        </div>
        <div class="muted">–ï—Å–ª–∏ –Ω–µ –∑–∞–¥–∞—Ç—å ‚Äî –∞–≥–µ–Ω—Ç –æ–±—è–∑–∞–Ω –∑–∞–ø—Ä–æ—Å–∏—Ç—å —É—Ç–æ—á–Ω–µ–Ω–∏—è (–≤ –∏–¥–µ–∞–ª–µ).</div>
      </div>
      <div>
        <label>–í–∞–ª—é—Ç–∞ (currency)</label>
        <input id="currency" value="USD" />
      </div>
    </div>

    <div class="row3" style="margin-top:10px;">
      <div>
        <label>–ë–µ–Ω—á–º–∞—Ä–∫: —Å–µ–∫—Ç–æ—Ä–Ω—ã–π ETF (benchmarks.sector)</label>
        <input id="bmSector" value="XLK" placeholder="–ù–∞–ø—Ä–∏–º–µ—Ä: XLK" />
      </div>
      <div>
        <label>–ë–µ–Ω—á–º–∞—Ä–∫: —à–∏—Ä–æ–∫–∏–π —Ä—ã–Ω–æ–∫ (benchmarks.broad)</label>
        <input id="bmBroad" value="SPY" placeholder="–ù–∞–ø—Ä–∏–º–µ—Ä: SPY" />
      </div>
      <div>
        <label>Budget confirm</label>
        <div class="checkboxRow">
          <input id="budgetOk" type="checkbox" />
          <div class="muted">–ü–æ–¥—Ç–≤–µ—Ä–∂–¥–∞—é –ø–µ—Ä–µ—Ä–∞—Å—Ö–æ–¥ –±—é–¥–∂–µ—Ç–∞ (–µ—Å–ª–∏ cost guard —Å—Ä–∞–±–æ—Ç–∞–µ—Ç).</div>
        </div>
      </div>
    </div>

    <div class="row" style="margin-top:10px;">
      <div>
        <label>Constraints (JSON, –æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ)</label>
        <textarea id="constraintsJson" rows="3" placeholder='–ù–∞–ø—Ä–∏–º–µ—Ä: {"no_leverage":true,"esg":false}'></textarea>
        <div class="muted">–≠—Ç–æ –æ–±—â–∏–µ –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–∏—è –ø–æ–ª–∏—Ç–∏–∫–∏ –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç–∞, –Ω–µ –ø–µ—Ä—Å–æ–Ω–∞–ª–∏–∑–∞—Ü–∏—è.</div>
      </div>
      <div>
        <label>Data pack overrides (JSON, –æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ)</label>
        <textarea id="overridesJson" rows="3" placeholder='–î–ª—è manual/MVP –º–æ–∂–Ω–æ –ø–æ–¥–ª–æ–∂–∏—Ç—å —á–∏—Å–ª–∞ —Å—é–¥–∞ (–µ—Å–ª–∏ backend —ç—Ç–æ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç).'></textarea>
        <div class="muted">–ï—Å–ª–∏ backend –Ω–µ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç ‚Äî –ø–æ–ª–µ –±—É–¥–µ—Ç –ø—Ä–æ–∏–≥–Ω–æ—Ä–∏—Ä–æ–≤–∞–Ω–æ.</div>
      </div>
    </div>

    <div class="toolbar" style="margin-top:10px;">
      <button class="secondary" onclick="estimate()">Estimate Cost</button>
      <button onclick="createRun()">Run Committee</button>
      <button class="secondary smallBtn" onclick="copyRunId()" id="copyBtn" disabled>Copy run_id</button>
      <span class="muted" id="uiMsg" style="margin-left:auto;"></span>
    </div>

    <div class="note">
      –í–∞–∂–Ω–æ: –µ—Å–ª–∏ Data Pack –æ—Ç—Å—É—Ç—Å—Ç–≤—É–µ—Ç/–Ω–µ–∫–∞—á–µ—Å—Ç–≤–µ–Ω–Ω—ã–π, –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ–µ –ø–æ–≤–µ–¥–µ–Ω–∏–µ ‚Äî –ø–µ—Ä–µ—Ö–æ–¥ –≤ —Ä–µ–∂–∏–º <b>NEED_DATA_PACK</b> (–±–µ–∑ –≤—ã–¥—É–º–æ–∫).
    </div>
  </div>

  <!-- ESTIMATE -->
  <div class="card">
    <h2>2) –û—Ü–µ–Ω–∫–∞ —Å—Ç–æ–∏–º–æ—Å—Ç–∏ (Cost Guard)</h2>
    <div class="muted">–ó–∞–≤–∏—Å–∏—Ç –æ—Ç pricing.yaml –∏ –º–æ–¥–µ–ª–µ–π. –ï—Å–ª–∏ –Ω–µ—Ç –ø—Ä–∞–π—Å–∞ ‚Äî —Å—Ç–æ–∏–º–æ—Å—Ç—å –º–æ–∂–µ—Ç –±—ã—Ç—å N/A.</div>
    <pre id="estBox">‚Äî</pre>
  </div>

  <!-- CURRENT RUN -->
  <div class="card">
    <h2>3) –¢–µ–∫—É—â–∏–π –ø—Ä–æ–≥–æ–Ω</h2>
    <div class="toolbar">
      <button class="secondary" onclick="refresh()">Refresh</button>
      <button class="secondary" onclick="loadResult()">Load Result</button>
      <button class="secondary" onclick="approve()">Approve edits</button>
      <button onclick="genPdf()" id="pdfBtn">Generate PDF</button>
      <button class="secondary" onclick="openPdf()" id="openPdfBtn">Open PDF</button>
    </div>

    <div style="margin-top:10px;">
      <span class="badge"><span class="dot info"></span><span id="badgeRun">run_id: ‚Äî</span></span>
      <span class="badge"><span class="dot info"></span><span id="badgeStatus">status: ‚Äî</span></span>
      <span class="badge"><span class="dot info"></span><span id="badgeMode">output_mode: ‚Äî</span></span>
      <span class="badge"><span class="dot info"></span><span id="badgeQuant">quant: ‚Äî</span></span>
      <span class="badge"><span class="dot info"></span><span id="badgeDP">data_pack: ‚Äî</span></span>
      <span class="badge"><span class="dot info"></span><span id="badgeTrad">tradability: ‚Äî</span></span>
      <span class="badge"><span class="dot info"></span><span id="badgeVal">validators: ‚Äî</span></span>
    </div>

    <pre id="runBox" style="margin-top:10px;">‚Äî</pre>
  </div>

  <!-- TABS: PROTOCOL VIEW vs RAW JSON -->
  <div class="card">
    <h2>4) –†–µ–∑—É–ª—å—Ç–∞—Ç</h2>
    <div class="tabs">
      <div class="tab active" id="tabProtocol" onclick="setTab('protocol')">Protocol view</div>
      <div class="tab" id="tabJson" onclick="setTab('json')">Raw JSON</div>
    </div>

    <!-- PROTOCOL VIEW -->
    <div id="viewProtocol">
      <div class="card" style="background:transparent; border:none; padding:0; margin:0 0 12px;">
        <h3>4.1 –ö–æ–º–∏—Ç–µ—Ç: —Ä–æ–ª–∏</h3>
        <div class="gridRoles">
          <div class="roleCard optimist">
            <h3>üìà –û–ø—Ç–∏–º–∏—Å—Ç (Bull)</h3>
            <div id="roleOptimist" class="roleText">–û–∂–∏–¥–∞–Ω–∏–µ...</div>
          </div>
          <div class="roleCard pessimist">
            <h3>üìâ –ü–µ—Å—Å–∏–º–∏—Å—Ç (Bear)</h3>
            <div id="rolePessimist" class="roleText">–û–∂–∏–¥–∞–Ω–∏–µ...</div>
          </div>
          <div class="roleCard realist">
            <h3>üß≠ –†–µ–∞–ª–∏—Å—Ç (Base)</h3>
            <div id="roleRealist" class="roleText">–û–∂–∏–¥–∞–Ω–∏–µ...</div>
          </div>
          <div class="roleCard quant">
            <h3>üßÆ Quant (—á–∏—Å–ª–∞/–≥—Ä–∞—Ñ–∏–∫–∏)</h3>
            <div id="roleQuant" class="roleText">–û–∂–∏–¥–∞–Ω–∏–µ...</div>
          </div>
        </div>
      </div>

      <div class="card" style="background:transparent; border:none; padding:0; margin:0;">
        <h3>4.2 –°—É–¥—å—è: –≤–µ—Ä–¥–∏–∫—Ç</h3>
        <pre id="verdictBox">–ó–¥–µ—Å—å –ø–æ—è–≤–∏—Ç—Å—è –≤–µ—Ä–¥–∏–∫—Ç (Judge) –ø–æ—Å–ª–µ –∑–∞–≥—Ä—É–∑–∫–∏ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–∞‚Ä¶</pre>
      </div>

      <div class="card" style="background:transparent; border:none; padding:0; margin:0;">
        <h3>4.3 –ì–µ–π—Ç—ã (Data Pack / Tradability / Macro) ‚Äî –∫—Ä–∞—Ç–∫–æ</h3>
        <div class="row3">
          <div class="card" style="margin:0;">
            <div class="muted">Data Pack</div>
            <pre id="gatesDataPack">‚Äî</pre>
          </div>
          <div class="card" style="margin:0;">
            <div class="muted">Tradability</div>
            <pre id="gatesTradability">‚Äî</pre>
          </div>
          <div class="card" style="margin:0;">
            <div class="muted">Macro next 14d / risk windows</div>
            <pre id="gatesMacro">‚Äî</pre>
          </div>
        </div>
      </div>

      <div class="card" style="background:transparent; border:none; padding:0; margin:0;">
        <h3>4.4 –°—Ü–µ–Ω–∞—Ä–Ω–∞—è –º–∞—Ç—Ä–∏—Ü–∞ (–∏–∑ Decision Card)</h3>
        <div class="muted">–í–µ—Ä–æ—è—Ç–Ω–æ—Å—Ç–∏ ‚Äî –¥–∏–∞–ø–∞–∑–æ–Ω–∞–º–∏ (%), —à–∞–≥ 5‚Äì10%. –î–∏–∞–ø–∞–∑–æ–Ω—ã –¥–æ–ª–∂–Ω—ã –±—ã—Ç—å —Å–æ–≤–º–µ—Å—Ç–∏–º—ã —Å 100%.</div>
        <div id="scenariosTableWrap" style="margin-top:10px;"></div>
      </div>

      <div class="card" style="background:transparent; border:none; padding:0; margin:0;">
        <h3>4.5 Issues Table (—Å–ø–æ—Ä–Ω—ã–µ –ø—É–Ω–∫—Ç—ã)</h3>
        <div id="issuesTableWrap" style="margin-top:10px;"></div>
      </div>

      <div class="card" style="background:transparent; border:none; padding:0; margin:0;">
        <h3>4.6 –†–∞–º–∫–∞ buy/hold/sell (—É—Å–ª–æ–≤–∏—è, –Ω–µ –ø—Ä–∏–∫–∞–∑)</h3>
        <div id="decisionFrameWrap" style="margin-top:10px;"></div>
      </div>
    </div>

    <!-- RAW JSON VIEW -->
    <div id="viewJson" class="hidden">
      <div class="muted">Run Result JSON (draft/approved). –£–¥–æ–±–Ω–æ –¥–ª—è –¥–µ–±–∞–≥–∞ –≤–∞–ª–∏–¥–∞—Ç–æ—Ä–æ–≤ –∏ –∞—Ä—Ç–µ—Ñ–∞–∫—Ç–æ–≤.</div>
      <pre id="resultJsonBox">‚Äî</pre>
    </div>
  </div>

  <!-- REVIEW MODE -->
  <div class="card">
    <h2>5) Review Mode</h2>
    <div class="muted">–ü—Ä–∞–≤–∏—Ç–µ —Ç–æ–ª—å–∫–æ Verdict –∏ Decision Card (JSON). –ü–æ—Ç–æ–º <b>Approve</b>. PDF –¥–æ–ª–∂–µ–Ω –≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞—Ç—å—Å—è —Ç–æ–ª—å–∫–æ –∏–∑ approved –≤–µ—Ä—Å–∏–∏ –∏ –ø—Ä–∏ PASS –≤–∞–ª–∏–¥–∞—Ç–æ—Ä–æ–≤.</div>
    <label>Verdict (editable)</label>
    <textarea id="verdictEdit" rows="8" placeholder="–ó–∞–≥—Ä—É–∑–∏—Ç–µ —Ä–µ–∑—É–ª—å—Ç–∞—Ç –∏ –ø—Ä–∏ –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ—Å—Ç–∏ –æ—Ç—Ä–µ–¥–∞–∫—Ç–∏—Ä—É–π—Ç–µ –≤–µ—Ä–¥–∏–∫—Ç‚Ä¶"></textarea>
    <label>Decision Card JSON (editable)</label>
    <textarea id="dcEdit" rows="14" style="font-family: var(--mono);" placeholder="–ó–∞–≥—Ä—É–∑–∏—Ç–µ —Ä–µ–∑—É–ª—å—Ç–∞—Ç, —á—Ç–æ–±—ã —É–≤–∏–¥–µ—Ç—å Decision Card‚Ä¶"></textarea>
    <div class="toolbar" style="margin-top:10px;">
      <button class="secondary" onclick="loadResult()">Reload from backend</button>
      <button onclick="approve()">Approve edits</button>
    </div>
  </div>

  <!-- HISTORY -->
  <div class="card">
    <h2>6) –ò—Å—Ç–æ—Ä–∏—è –ø—Ä–æ–≥–æ–Ω–æ–≤</h2>
    <div class="toolbar">
      <button class="secondary" onclick="loadHistory()">Refresh history</button>
      <span class="muted">–ö–ª–∏–∫ –ø–æ —Å—Ç—Ä–æ–∫–µ –ø–æ–¥—Å—Ç–∞–≤–∏—Ç run_id —Å–≤–µ—Ä—Ö—É.</span>
    </div>
    <div id="historyWrap" style="margin-top:10px;"></div>
  </div>

  <div class="card">
    <div class="muted">
      –î–∏—Å–∫–ª–µ–π–º–µ—Ä: –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å –ø—Ä–µ–¥–Ω–∞–∑–Ω–∞—á–µ–Ω –¥–ª—è –∞–Ω–∞–ª–∏—Ç–∏–∫–∏ –∏ –æ–±—Å—É–∂–¥–µ–Ω–∏—è. –ù–µ —è–≤–ª—è–µ—Ç—Å—è –∏–Ω–¥–∏–≤–∏–¥—É–∞–ª—å–Ω–æ–π –∏–Ω–≤–µ—Å—Ç–∏—Ü–∏–æ–Ω–Ω–æ–π —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–µ–π.
    </div>
  </div>
</div>

<script>
  let RUN_ID = null;
  let LAST_RUN_STATUS = null;

  function uiMessage(text, type="info"){
    const el = document.getElementById("uiMsg");
    el.textContent = text || "";
  }

  function setTab(which){
    const protocol = document.getElementById("viewProtocol");
    const json = document.getElementById("viewJson");
    const tabP = document.getElementById("tabProtocol");
    const tabJ = document.getElementById("tabJson");
    if(which === "json"){
      protocol.classList.add("hidden");
      json.classList.remove("hidden");
      tabP.classList.remove("active");
      tabJ.classList.add("active");
    } else {
      json.classList.add("hidden");
      protocol.classList.remove("hidden");
      tabJ.classList.remove("active");
      tabP.classList.add("active");
    }
  }

  function setLoadingProtocol(){
    const loading = '<span class="loading">–ê–Ω–∞–ª–∏–∑–∏—Ä—É—é‚Ä¶</span>';
    document.getElementById("roleOptimist").innerHTML = loading;
    document.getElementById("rolePessimist").innerHTML = loading;
    document.getElementById("roleRealist").innerHTML = loading;
    document.getElementById("roleQuant").innerHTML = loading;
    document.getElementById("verdictBox").textContent = "–°—É–¥—å—è –ø–∏—à–µ—Ç –∑–∞–∫–ª—é—á–µ–Ω–∏–µ‚Ä¶";
    document.getElementById("gatesDataPack").textContent = "‚Äî";
    document.getElementById("gatesTradability").textContent = "‚Äî";
    document.getElementById("gatesMacro").textContent = "‚Äî";
    document.getElementById("scenariosTableWrap").innerHTML = "";
    document.getElementById("issuesTableWrap").innerHTML = "";
    document.getElementById("decisionFrameWrap").innerHTML = "";
  }

  function applyHorizonPreset(){
    const preset = document.getElementById("horizonPreset").value;
    if(preset && preset !== "custom"){
      document.getElementById("horizonDays").value = preset;
    }
  }

  function safeJsonParse(text, fallback){
    const s = (text || "").trim();
    if(!s) return fallback;
    try { return JSON.parse(s); }
    catch(e){ return {__parse_error: e.message, __raw: s}; }
  }

  function payloadBase(){
    const symbols = document.getElementById("symbols").value
      .split(",").map(s => s.trim()).filter(Boolean);

    const constraintsParsed = safeJsonParse(document.getElementById("constraintsJson").value, {});
    const overridesParsed = safeJsonParse(document.getElementById("overridesJson").value, {});

    const payload = {
      mode: document.getElementById("mode").value,
      symbols,
      prompt: document.getElementById("prompt").value.trim(),
      harshness: document.getElementById("harshness").value,
    };

    // Optional inputs block (–ø–æ –¢–ó)
    const horizon_days = parseInt(document.getElementById("horizonDays").value, 10);
    const currency = document.getElementById("currency").value.trim() || "USD";
    const sector = document.getElementById("bmSector").value.trim();
    const broad = document.getElementById("bmBroad").value.trim() || "SPY";

    payload.inputs = {
      horizon_days: isFinite(horizon_days) ? horizon_days : null,
      currency: currency || null,
      benchmarks: (sector || broad) ? { sector: sector || "", broad: broad || "SPY" } : null,
      constraints: (constraintsParsed && !constraintsParsed.__parse_error) ? constraintsParsed : {},
    };

    payload.data_pack_overrides = (overridesParsed && !overridesParsed.__parse_error) ? overridesParsed : {};

    payload.max_rounds = parseInt(document.getElementById("maxRounds").value, 10) || 3;
    payload.requested_output_mode = document.getElementById("outmode").value;
    payload.quant_mode = document.getElementById("qmode").value;
    payload.budget_confirmed = document.getElementById("budgetOk").checked;

    // UI warnings for JSON parse errors (–Ω–µ –±–ª–æ–∫–∏—Ä—É–µ–º)
    if(constraintsParsed && constraintsParsed.__parse_error){
      uiMessage("‚ö†Ô∏è Constraints JSON –Ω–µ–≤–∞–ª–∏–¥–µ–Ω ‚Äî –æ—Ç–ø—Ä–∞–≤–ª—è—é –ø—É—Å—Ç–æ–π –æ–±—ä–µ–∫—Ç.", "warn");
      payload.inputs.constraints = {};
    }
    if(overridesParsed && overridesParsed.__parse_error){
      uiMessage("‚ö†Ô∏è Overrides JSON –Ω–µ–≤–∞–ª–∏–¥–µ–Ω ‚Äî –æ—Ç–ø—Ä–∞–≤–ª—è—é –ø—É—Å—Ç–æ–π –æ–±—ä–µ–∫—Ç.", "warn");
      payload.data_pack_overrides = {};
    }

    return payload;
  }

  async function estimate(){
    uiMessage("");
    const p = payloadBase();
    if(!p.prompt){ alert("–í–≤–µ–¥–∏—Ç–µ prompt"); return; }
    if(!p.symbols.length){ alert("–í–≤–µ–¥–∏—Ç–µ —Ç–∏–∫–µ—Ä(–∞)"); return; }

    document.getElementById("estBox").textContent = "–°—á–∏—Ç–∞—é‚Ä¶";
    try{
      const res = await fetch("/api/estimate", {
        method:"POST",
        headers:{ "Content-Type":"application/json" },
        body: JSON.stringify({
          mode: p.mode,
          symbols: p.symbols,
          prompt: p.prompt,
          harshness: p.harshness
        })
      });
      const data = await res.json();
      if(!res.ok) throw new Error(data?.detail || "Estimate error");
      document.getElementById("estBox").textContent = JSON.stringify(data, null, 2);
    } catch(e){
      document.getElementById("estBox").textContent = "–û—à–∏–±–∫–∞: " + e.message;
    }
  }

  function setRunBadges(run){
    const set = (id, text) => (document.getElementById(id).textContent = text);
    set("badgeRun", "run_id: " + (RUN_ID || "‚Äî"));
    set("badgeStatus", "status: " + (run?.status || "‚Äî"));
    set("badgeMode", "output_mode: " + (run?.output_mode || "‚Äî"));
    set("badgeQuant", "quant: " + (run?.quant_enabled ? "ON" : (run?.quant_enabled === false ? "OFF" : "‚Äî")));
    set("badgeDP", "data_pack: " + (run?.data_pack_status || "‚Äî"));
    set("badgeTrad", "tradability: " + (run?.tradability_status || "‚Äî"));
    const v = run?.validators_ok;
    set("badgeVal", "validators: " + (v === true ? "PASS" : (v === false ? "FAIL" : "‚Äî")));

    // Enable copy
    const copyBtn = document.getElementById("copyBtn");
    copyBtn.disabled = !RUN_ID;

    // PDF button guard (–ª—É—á—à–µ, –Ω–æ backend –≤—Å—ë —Ä–∞–≤–Ω–æ –¥–æ–ª–∂–µ–Ω –ø—Ä–æ–≤–µ—Ä—è—Ç—å)
    const pdfBtn = document.getElementById("pdfBtn");
    const openPdfBtn = document.getElementById("openPdfBtn");

    const approvedPath = run?.result_ref?.approved_json_path;
    const pdfPath = run?.result_ref?.pdf_path;

    // –ü–æ –¢–ó: PDF –≥–µ–Ω–µ—Ä–∏—Ä—É–µ—Ç—Å—è —Ç–æ–ª—å–∫–æ –∏–∑ approved –≤–µ—Ä—Å–∏–∏ –∏ –ø—Ä–∏ PASS –≤–∞–ª–∏–¥–∞—Ç–æ—Ä–æ–≤
    const canGeneratePdf = !!RUN_ID && (run?.validators_ok === true) && !!approvedPath;
    pdfBtn.disabled = !canGeneratePdf;

    // PDF –º–æ–∂–Ω–æ –æ—Ç–∫—Ä—ã—Ç—å, —Ç–æ–ª—å–∫–æ –µ—Å–ª–∏ –æ–Ω —É–∂–µ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç
    const canOpenPdf = !!RUN_ID && !!pdfPath;
    openPdfBtn.disabled = !canOpenPdf;
  }

  async function createRun(){
    uiMessage("");
    setLoadingProtocol();
    const p = payloadBase();
    if(!p.prompt){ alert("–í–≤–µ–¥–∏—Ç–µ prompt"); return; }
    if(!p.symbols.length){ alert("–í–≤–µ–¥–∏—Ç–µ —Ç–∏–∫–µ—Ä(–∞)"); return; }

    // UI feedback
    document.getElementById("runBox").textContent = "–°–æ–∑–¥–∞—é run‚Ä¶";
    document.getElementById("resultJsonBox").textContent = "‚Äî";

    try{
      const res = await fetch("/api/runs", {
        method:"POST",
        headers:{ "Content-Type":"application/json" },
        body: JSON.stringify(p)
      });
      const data = await res.json();
      if(!res.ok) throw new Error(data?.detail || "Run create error");
      RUN_ID = data.run_id;
      document.getElementById("runBox").textContent = JSON.stringify(data, null, 2);
      setRunBadges(data);
      uiMessage("‚úÖ Run —Å–æ–∑–¥–∞–Ω. –ù–∞–∂–º–∏—Ç–µ Refresh, –ø–æ–∫–∞ status –Ω–µ —Å—Ç–∞–Ω–µ—Ç review_pending / –≥–æ—Ç–æ–≤.", "info");
      // auto refresh once
      setTimeout(refresh, 700);
    } catch(e){
      document.getElementById("runBox").textContent = "–û—à–∏–±–∫–∞: " + e.message;
      uiMessage("–û—à–∏–±–∫–∞ —Å–æ–∑–¥–∞–Ω–∏—è –ø—Ä–æ–≥–æ–Ω–∞: " + e.message, "bad");
    }
  }

  async function refresh(){
    if(!RUN_ID){ alert("–ù–µ—Ç run_id"); return; }
    uiMessage("");
    try{
      const res = await fetch(`/api/runs/${RUN_ID}`);
      const data = await res.json();
      if(!res.ok) throw new Error(data?.detail || "Refresh error");
      LAST_RUN_STATUS = data;
      document.getElementById("runBox").textContent = JSON.stringify(data, null, 2);
      setRunBadges(data);
      if(data?.error){
        uiMessage("‚ö†Ô∏è Backend error: " + data.error, "warn");
      }
    } catch(e){
      document.getElementById("runBox").textContent = "–û—à–∏–±–∫–∞: " + e.message;
      uiMessage("–û—à–∏–±–∫–∞ Refresh: " + e.message, "bad");
    }
  }

  function pickAgentText(agents, keys, field="final"){
    if(!agents) return "";
    for(const k of keys){
      const a = agents[k];
      if(a && typeof a === "object"){
        const txt = a[field] || a["final"] || a["draft"] || "";
        if(txt) return txt;
      }
      if(typeof a === "string" && a) return a;
    }
    return "";
  }

  function renderScenarioTable(decisionCard){
    const scenarios = decisionCard?.scenarios || [];
    if(!Array.isArray(scenarios) || scenarios.length === 0){
      return '<div class="muted">–°—Ü–µ–Ω–∞—Ä–∏–µ–≤ –Ω–µ—Ç (–∏–ª–∏ —Ä–µ–∂–∏–º NEED_DATA_PACK).</div>';
    }
    let html = '<table><thead><tr>' +
      '<th>–°—Ü–µ–Ω–∞—Ä–∏–π</th>' +
      '<th>–í–µ—Ä–æ—è—Ç–Ω–æ—Å—Ç—å (–¥–∏–∞–ø–∞–∑–æ–Ω, %)</th>' +
      '<th>–ù–∞—Ä—Ä–∞—Ç–∏–≤</th>' +
      '<th>–ü–æ—Å–ª–µ–¥—Å—Ç–≤–∏—è</th>' +
      '<th>–¢—Ä–∏–≥–≥–µ—Ä—ã –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—è</th>' +
      '<th>–¢—Ä–∏–≥–≥–µ—Ä—ã –æ–ø—Ä–æ–≤–µ—Ä–∂–µ–Ω–∏—è/–ø–µ—Ä–µ—Å–º–æ—Ç—Ä–∞</th>' +
      '</tr></thead><tbody>';

    for(const s of scenarios){
      const name = s?.name ?? "‚Äî";
      const pr = Array.isArray(s?.p_range_pct) ? (s.p_range_pct[0] + "‚Äì" + s.p_range_pct[1]) : "‚Äî";
      const nar = (s?.narrative || "‚Äî");
      const cons = (s?.consequences || "‚Äî");
      const conf = Array.isArray(s?.confirm_triggers) ? s.confirm_triggers.join("\\n") : (s?.confirm_triggers || "‚Äî");
      const inv = Array.isArray(s?.invalidate_triggers) ? s.invalidate_triggers.join("\\n") : (s?.invalidate_triggers || "‚Äî");

      html += '<tr>' +
        `<td><b>${escapeHtml(name)}</b></td>` +
        `<td>${escapeHtml(pr)}</td>` +
        `<td>${escapeHtml(nar)}</td>` +
        `<td>${escapeHtml(cons)}</td>` +
        `<td>${escapeHtml(conf)}</td>` +
        `<td>${escapeHtml(inv)}</td>` +
        '</tr>';
    }
    html += '</tbody></table>';
    return html;
  }

  function renderIssuesTable(issues){
    if(!Array.isArray(issues) || issues.length === 0){
      return '<div class="muted">Issues table –æ—Ç—Å—É—Ç—Å—Ç–≤—É–µ—Ç (–∏–ª–∏ –ø—É—Å—Ç–æ).</div>';
    }
    let html = '<table><thead><tr>' +
      '<th>Severity</th>' +
      '<th>Category</th>' +
      '<th>Who</th>' +
      '<th>Statement</th>' +
      '<th>Why it matters</th>' +
      '<th>Fix / Check</th>' +
      '</tr></thead><tbody>';
    for(const it of issues){
      html += '<tr>' +
        `<td>${escapeHtml(it?.severity || "‚Äî")}</td>` +
        `<td>${escapeHtml(it?.category || "‚Äî")}</td>` +
        `<td>${escapeHtml(it?.who_flagged || "‚Äî")}</td>` +
        `<td>${escapeHtml(it?.statement || "‚Äî")}</td>` +
        `<td>${escapeHtml(it?.why_it_matters || "‚Äî")}</td>` +
        `<td>${escapeHtml(it?.fix_or_check || "‚Äî")}</td>` +
      '</tr>';
    }
    html += '</tbody></table>';
    return html;
  }

  function renderDecisionFrame(dc){
    const frame = dc?.decision_frame || {};
    const actionType = frame?.action_type || "‚Äî";
    const buy = Array.isArray(frame?.buy_if) ? frame.buy_if : [];
    const hold = Array.isArray(frame?.hold_if) ? frame.hold_if : [];
    const sell = Array.isArray(frame?.sell_or_reduce_if) ? frame.sell_or_reduce_if : [];

    const block = (title, arr) => {
      const items = arr.length ? ("<ul>" + arr.map(x => `<li>${escapeHtml(x)}</li>`).join("") + "</ul>") : "<div class='muted'>‚Äî</div>";
      return `<div class="card" style="margin:0;"><div class="muted">${escapeHtml(title)}</div>${items}</div>`;
    };

    return `
      <div class="badge"><span class="dot info"></span><span>action_type: <b>${escapeHtml(actionType)}</b></span></div>
      <div class="row3" style="margin-top:10px;">
        ${block("Buy if", buy)}
        ${block("Hold if", hold)}
        ${block("Sell/Reduce if", sell)}
      </div>
    `;
  }

  function summarizeGates(resultJson){
    const gates = resultJson?.gates || resultJson?.decision_card?.gates || {};
    const dp = gates?.data_pack || {};
    const trad = gates?.tradability || {};
    const macro = gates?.macro || {};

    document.getElementById("gatesDataPack").textContent = JSON.stringify(dp, null, 2) || "‚Äî";
    document.getElementById("gatesTradability").textContent = JSON.stringify(trad, null, 2) || "‚Äî";
    document.getElementById("gatesMacro").textContent = JSON.stringify(macro, null, 2) || "‚Äî";
  }

  function escapeHtml(str){
    if(str === null || str === undefined) return "";
    return String(str)
      .replaceAll("&","&amp;")
      .replaceAll("<","&lt;")
      .replaceAll(">","&gt;")
      .replaceAll('"',"&quot;")
      .replaceAll("'","&#039;");
  }

  async function loadResult(){
    if(!RUN_ID){ alert("–ù–µ—Ç run_id"); return; }
    uiMessage("");
    setLoadingProtocol();
    try{
      const res = await fetch(`/api/runs/${RUN_ID}/result`);
      const data = await res.json();
      if(!res.ok) throw new Error(data?.detail || "Load result error");

      // Raw JSON view
      document.getElementById("resultJsonBox").textContent = JSON.stringify(data, null, 2);

      // Populate review editor
      document.getElementById("verdictEdit").value = data?.verdict || "";
      document.getElementById("dcEdit").value = JSON.stringify(data?.decision_card || {}, null, 2);

      // Protocol view: roles
      const agents = data?.agents || {};
      document.getElementById("roleOptimist").textContent = pickAgentText(agents, ["optimist","bull"], "final") || "‚Äî";
      document.getElementById("rolePessimist").textContent = pickAgentText(agents, ["pessimist","bear"], "final") || "‚Äî";
      document.getElementById("roleRealist").textContent = pickAgentText(agents, ["realist","base"], "final") || "‚Äî";
      // Quant can be a text or object with result; show something useful
      const q = agents?.quant;
      let qText = "";
      if(typeof q === "string") qText = q;
      else if(q && typeof q === "object"){
        qText = q.final || q.draft || (q.result ? JSON.stringify(q.result, null, 2) : "");
      }
      document.getElementById("roleQuant").textContent = qText || "‚Äî";

      // Verdict
      document.getElementById("verdictBox").textContent = data?.verdict || "‚Äî";

      // Gates summary
      summarizeGates(data);

      // Decision Card extracted views
      const dc = data?.decision_card || {};
      document.getElementById("scenariosTableWrap").innerHTML = renderScenarioTable(dc);
      document.getElementById("issuesTableWrap").innerHTML = renderIssuesTable(data?.issues_table);
      document.getElementById("decisionFrameWrap").innerHTML = renderDecisionFrame(dc);

      uiMessage("‚úÖ Result –∑–∞–≥—Ä—É–∂–µ–Ω. –ï—Å–ª–∏ –Ω—É–∂–Ω–æ ‚Äî –ø—Ä–∞–≤—å—Ç–µ –≤ Review Mode –∏ –∂–º–∏—Ç–µ Approve.", "info");
    } catch(e){
      document.getElementById("verdictBox").textContent = "–û—à–∏–±–∫–∞: " + e.message;
      document.getElementById("resultJsonBox").textContent = "–û—à–∏–±–∫–∞: " + e.message;
      uiMessage("–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–∞: " + e.message, "bad");
    } finally {
      // update badges (status/validators) after loading result
      refresh();
    }
  }

  async function approve(){
    if(!RUN_ID){ alert("–ù–µ—Ç run_id"); return; }
    uiMessage("");
    let dc;
    try{
      dc = JSON.parse(document.getElementById("dcEdit").value || "{}");
    } catch(e){
      alert("Decision Card JSON –Ω–µ–≤–∞–ª–∏–¥–µ–Ω. –ò—Å–ø—Ä–∞–≤—å—Ç–µ –∏ –ø–æ–≤—Ç–æ—Ä–∏—Ç–µ.");
      return;
    }

    try{
      const res = await fetch(`/api/runs/${RUN_ID}/approve`, {
        method:"POST",
        headers:{ "Content-Type":"application/json" },
        body: JSON.stringify({
          verdict_edited: document.getElementById("verdictEdit").value || "",
          decision_card_edited: dc
        })
      });
      const data = await res.json();
      if(!res.ok) throw new Error(data?.detail || "Approve error");
      uiMessage("‚úÖ Approved. –í–∞–ª–∏–¥–∞—Ç–æ—Ä—ã –¥–æ–ª–∂–Ω—ã –±—ã—Ç—å –ø–µ—Ä–µ–∑–∞–ø—É—â–µ–Ω—ã –Ω–∞ —Å—Ç–æ—Ä–æ–Ω–µ backend.", "info");
      // Refresh status (validators_ok –º–æ–∂–µ—Ç –∏–∑–º–µ–Ω–∏—Ç—å—Å—è)
      setTimeout(refresh, 400);
    } catch(e){
      uiMessage("–û—à–∏–±–∫–∞ Approve: " + e.message, "bad");
      alert("Approve error: " + e.message);
    }
  }

  async function genPdf(){
    if(!RUN_ID){ alert("–ù–µ—Ç run_id"); return; }
    uiMessage("");
    try{
      const res = await fetch(`/api/runs/${RUN_ID}/generate_pdf`, { method:"POST" });
      const data = await res.json();
      if(!res.ok) throw new Error(data?.detail || "PDF generation blocked");
      uiMessage("‚úÖ PDF queued. –û—Ç–∫—Ä–æ–π—Ç–µ PDF –ø–æ—Å–ª–µ —Å—Ç–∞—Ç—É—Å–∞ pdf_done.", "info");
      setTimeout(refresh, 700);
    } catch(e){
      uiMessage("–û—à–∏–±–∫–∞ PDF: " + e.message, "bad");
      alert("PDF error: " + e.message);
    }
  }

  function openPdf(){
    if(!RUN_ID){ alert("–ù–µ—Ç run_id"); return; }
    window.open(`/api/runs/${RUN_ID}/pdf`, "_blank");
  }

  async function loadHistory(){
    uiMessage("");
    try{
      const res = await fetch(`/api/runs?limit=30`);
      const data = await res.json();
      if(!res.ok) throw new Error(data?.detail || "History error");
      if(!Array.isArray(data) || data.length === 0){
        document.getElementById("historyWrap").innerHTML = "<div class='muted'>–ò—Å—Ç–æ—Ä–∏—è –ø—É—Å—Ç–∞.</div>";
        return;
      }

      let html = '<table><thead><tr>' +
        '<th>created_at</th>' +
        '<th>run_id</th>' +
        '<th>status</th>' +
        '<th>mode</th>' +
        '<th>symbols</th>' +
        '<th>tradability</th>' +
        '<th>pdf</th>' +
      '</tr></thead><tbody>';

      for(const r of data){
        const rid = r?.run_id || "";
        const safeRid = String(rid).replaceAll("\\\\", "\\\\\\\\").replaceAll("'", "\\\\'");
        const pdfPath = r?.result_ref?.pdf_path || r?.pdf_path;
        const pdf = pdfPath ? "–µ—Å—Ç—å" : "‚Äî";
        html += '<tr style="cursor:pointer" onclick="selectRunId(\\'' + safeRid + '\\')">' +
          `<td>${escapeHtml(r?.created_at || "‚Äî")}</td>` +
          `<td><b>${escapeHtml(rid)}</b></td>` +
          `<td>${escapeHtml(r?.status || "‚Äî")}</td>` +
          `<td>${escapeHtml(r?.mode || "‚Äî")}</td>` +
          `<td>${escapeHtml((r?.symbols || []).join(","))}</td>` +
          `<td>${escapeHtml(r?.tradability_status || "‚Äî")}</td>` +
          `<td>${escapeHtml(pdf)}</td>` +
        '</tr>';
      }
      html += '</tbody></table>';
      document.getElementById("historyWrap").innerHTML = html;
    } catch(e){
      document.getElementById("historyWrap").innerHTML = "<div class='muted'>–û—à–∏–±–∫–∞: " + escapeHtml(e.message) + "</div>";
      uiMessage("–û—à–∏–±–∫–∞ history: " + e.message, "bad");
    }
  }

  function selectRunId(runId){
    if(!runId) return;
    RUN_ID = runId;
    document.getElementById("badgeRun").textContent = "run_id: " + RUN_ID;
    document.getElementById("copyBtn").disabled = false;
    uiMessage("‚úÖ –í—ã–±—Ä–∞–Ω run_id –∏–∑ –∏—Å—Ç–æ—Ä–∏–∏. –ù–∞–∂–º–∏—Ç–µ Refresh / Load Result.", "info");
    refresh();
  }

  async function copyRunId(){
    if(!RUN_ID) return;
    try{
      await navigator.clipboard.writeText(RUN_ID);
      uiMessage("‚úÖ run_id —Å–∫–æ–ø–∏—Ä–æ–≤–∞–Ω –≤ –±—É—Ñ–µ—Ä –æ–±–º–µ–Ω–∞.", "info");
    } catch(e){
      uiMessage("‚ö†Ô∏è –ù–µ —É–¥–∞–ª–æ—Å—å —Å–∫–æ–ø–∏—Ä–æ–≤–∞—Ç—å run_id (clipboard –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω).", "warn");
    }
  }
</script>
</body>
</html>
